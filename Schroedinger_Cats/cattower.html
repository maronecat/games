<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Cat Tower Jump - Short Stage</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f0f8ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-family: sans-serif;
    }
    #gameCanvas {
      width: 360px;
      height: 640px;
      border: 2px solid #333;
      margin-top: 10px;
      display: block;
      background: #ffffff;
    }
    #mobileControls {
      margin-top: 10px;
    }
    #mobileControls button {
      font-size: 1.2rem;
      padding: 10px 20px;
      margin: 5px;
      min-width: 60px;
      border-radius: 8px;
      border: 1px solid #aaa;
      background: #fff;
    }
    #info {
      margin-top: 5px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="360" height="640"></canvas>

  <!-- ã‚¹ãƒãƒ›ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div id="mobileControls">
    <button id="leftBtn">â†</button>
    <button id="rightBtn">â†’</button>
    <button id="jumpBtn">Jump</button>
  </div>

  <div id="info">
    PCæ“ä½œ: ã‚¹ãƒšãƒ¼ã‚¹=ã‚¸ãƒ£ãƒ³ãƒ— / L=å³ / K=å·¦
  </div>

  <!-- çŒ«ã®é³´ãå£°ãƒ•ã‚¡ã‚¤ãƒ« (ãƒ–ãƒ©ã‚¦ã‚¶ã®åŒä¸€ã‚ªãƒªã‚¸ãƒ³åˆ¶ç´„ã«æ³¨æ„) -->
  <!-- ä¾‹: meow.wav ã‚’åŒãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ãã ã•ã„ã€‚ -->
  <audio id="meowSound" src="meow.wav" preload="auto"></audio>

  <script>
    // ==========================================
    // ã‚²ãƒ¼ãƒ è¨­å®šãƒ»å¤‰æ•°
    // ==========================================
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const CANVAS_WIDTH = canvas.width;   // 360
    const CANVAS_HEIGHT = canvas.height; // 640

    // çŒ«ã‚­ãƒ£ãƒ©
    let cat = {
      x: 160,
      y: 500,
      width: 40,    // å½“ãŸã‚Šåˆ¤å®šã®å¹…
      height: 40,   // å½“ãŸã‚Šåˆ¤å®šã®é«˜ã•
      vx: 0,
      vy: 0,
      onGround: false,
      facingRight: false
    };

    // å…¥åŠ›çŠ¶æ…‹
    let keys = { left: false, right: false, jump: false };

    // ç‰©ç†
    const GRAVITY = 0.4;
    const JUMP_POWER = -12;
    const MOVE_SPEED = 3;

    // è·é›¢(ä¸Šæ˜‡é‡)
    let distance = 0;
    let isGameRunning = true;

    // ã‚¹ãƒ†ãƒ¼ã‚¸åŒºåˆ‡ã‚Š(çŸ­ã‚)
    const GROUND_END  = 500;   // åœ°ä¸Šã‚¨ãƒªã‚¢ 0ï½500
    const SKY_END     = 1500;  // ç©ºã‚¨ãƒªã‚¢ 500ï½1500
    const SPACE_END   = 2500;  // å®‡å®™ã‚¨ãƒªã‚¢ 1500ï½2500
    const RAINBOW_END = 3000;  // è™¹è‰²ã‚¨ãƒªã‚¢ 2500ï½3000 â†’ ã‚´ãƒ¼ãƒ«
    const GOAL_DIST   = 3000;

    // ãƒ©ã‚¤ãƒ•
    let lives = 3;

    // çŒ«ã®é³´ãå£°
    const meowSound = document.getElementById("meowSound");

    // ==========================================
    // ã‚­ãƒ£ãƒƒãƒˆã‚¿ãƒ¯ãƒ¼(è¶³å ´)
    // ==========================================
    const towerColors = [
      "#ff7f7f", "#ff7fbf", "#ff7fff", "#bf7fff",
      "#7fbfff", "#7fffff", "#7fffbf", "#7fff7f",
      "#bfff7f", "#ffff7f", "#ffbf7f", "#7f7fff"
    ];

    let platforms = [];
    const TOWER_COLUMN_WIDTH = 15;
    const TOWER_COLUMN_HEIGHT = 50;

    function initPlatforms() {
      // åœ°é¢ã®ã‚ˆã†ãªè¶³å ´
      platforms.push({
        x: 0,
        y: 600,
        width: CANVAS_WIDTH,
        height: 20,
        color: "#ff7f7f"
      });

      // åˆæœŸè¶³å ´
      let currentY = 450;
      for (let i = 0; i < 5; i++) {
        addPlatform(currentY);
        currentY -= 100;
      }
    }

    function addPlatform(y) {
      const w = 80, h = 10;
      const x = Math.random() * (CANVAS_WIDTH - w);
      const color = towerColors[Math.floor(Math.random() * towerColors.length)];
      platforms.push({ x, y, width: w, height: h, color });
    }

    function addNewPlatformsIfNeeded() {
      let topPlatformY = Infinity;
      for (let p of platforms) {
        if (p.y < topPlatformY) topPlatformY = p.y;
      }
      while (topPlatformY > 0) {
        topPlatformY -= 100;
        addPlatform(topPlatformY);
      }
    }

    // ==========================================
    // éšœå®³ç‰©(é›²ã€æ˜Ÿã€å¤©ä½¿)
    // ==========================================
    let obstacles = [];
    let frameCount = 0;

    function spawnCloud() {
      const symbol = "â˜ï¸";
      const w = 30, h = 30;
      const fromLeft = (Math.random() < 0.5);
      let x, vx;
      if (fromLeft) {
        x = -w;
        vx = 1 + Math.random() * 1;  // 1~2
      } else {
        x = CANVAS_WIDTH + w;
        vx = -1 - Math.random() * 1; // -2~-1
      }
      const y = Math.random() * (CANVAS_HEIGHT / 2);
      obstacles.push({ x, y, vx, width: w, height: h, symbol, type: "cloud" });
    }

    function spawnStar() {
      const symbol = "âœ¨";
      const w = 20, h = 20;
      const fromLeft = (Math.random() < 0.5);
      let x, vx;
      if (fromLeft) {
        x = -w;
        vx = 2 + Math.random() * 2;
      } else {
        x = CANVAS_WIDTH + w;
        vx = -2 - Math.random() * 2;
      }
      const y = Math.random() * (CANVAS_HEIGHT / 2);
      obstacles.push({ x, y, vx, width: w, height: h, symbol, type: "star" });
    }

    function spawnAngel() {
      const symbol = "ğŸ‘¼";
      const w = 30, h = 30;
      const fromLeft = (Math.random() < 0.5);
      let x, vx;
      if (fromLeft) {
        x = -w;
        vx = 3 + Math.random() * 2;
      } else {
        x = CANVAS_WIDTH + w;
        vx = -3 - Math.random() * 2;
      }
      const y = Math.random() * (CANVAS_HEIGHT / 2);
      obstacles.push({ x, y, vx, width: w, height: h, symbol, type: "angel" });
    }

    function getCurrentArea(dist) {
      if (dist < GROUND_END)     return "ground";
      if (dist < SKY_END)        return "sky";
      if (dist < SPACE_END)      return "space";
      if (dist < RAINBOW_END)    return "rainbow";
      return "goal";
    }

    function updateObstacles() {
      const area = getCurrentArea(distance);

      // ã‚¨ãƒªã‚¢ã«å¿œã˜ã¦éšœå®³ç‰©ãŒå‡ºã‚‹
      if (area === "sky") {
        // é›²
        if (frameCount % 120 === 0) {
          spawnCloud();
        }
      } else if (area === "space") {
        // æ˜Ÿ
        let freq = 90;
        if (distance > 2000) freq = 60;
        if (frameCount % freq === 0) spawnStar();
      } else if (area === "rainbow") {
        // å¤©ä½¿
        let freq = 90;
        if (frameCount % freq === 0) spawnAngel();
      }

      // éšœå®³ç‰©ã®ç§»å‹•ï¼†è¡çªåˆ¤å®š
      for (let i = 0; i < obstacles.length; i++) {
        const o = obstacles[i];
        o.x += o.vx;
        // ç”»é¢å¤–ã«æ¶ˆãˆãŸã‚‰é™¤å»
        if (o.x < -100 || o.x > CANVAS_WIDTH + 100) {
          obstacles.splice(i, 1);
          i--;
          continue;
        }

        // AABBåˆ¤å®š: å››æ–¹ã©ã“ã‹ã‚‰ã§ã‚‚è¡çª
        if (
          cat.x < o.x + o.width &&
          cat.x + cat.width > o.x &&
          cat.y < o.y + o.height &&
          cat.y + cat.height > o.y
        ) {
          // è¡çªæ–¹å‘ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã€ä¸­å¿ƒåº§æ¨™ã§æ¯”è¼ƒ
          const catCenterX = cat.x + cat.width/2;
          const catCenterY = cat.y + cat.height/2;
          const obsCenterX = o.x + o.width/2;
          const obsCenterY = o.y + o.height/2;

          const dx = catCenterX - obsCenterX;
          const dy = catCenterY - obsCenterY;

          // æ¨ªæ–¹å‘ãƒ»ç¸¦æ–¹å‘ã©ã¡ã‚‰ã®è¡çªãŒå¤§ãã„ã‹
          if (Math.abs(dx) > Math.abs(dy)) {
            // å·¦å³è¡çª
            if (dx > 0) {
              // çŒ«ãŒéšœå®³ç‰©ã‚ˆã‚Šå³å´ => å³ã‹ã‚‰å·¦ã«æŠ¼ã•ã‚Œã‚‹
              cat.vx = Math.min(cat.vx, 0);
              cat.x = o.x + o.width; // æŠ¼ã—å‡ºã—
            } else {
              // çŒ«ãŒéšœå®³ç‰©ã‚ˆã‚Šå·¦å´ => å·¦ã‹ã‚‰å³ã«æŠ¼ã•ã‚Œã‚‹
              cat.vx = Math.max(cat.vx, 0);
              cat.x = o.x - cat.width;
            }
            // å°‘ã—å‚ç›´é€Ÿåº¦ã‚‚ã„ã˜ã‚‹ãªã‚‰ã‚„ã£ã¦ã‚‚OK
            // cat.vy = 3; ãªã©
          } else {
            // ä¸Šä¸‹è¡çª
            if (dy > 0) {
              // çŒ«ãŒéšœå®³ç‰©ã‚ˆã‚Šä¸‹ => ä¸‹ã‹ã‚‰ä¸Šã«æŠ¼ã—å‡ºã—
              cat.y = o.y + o.height;
              // ä¸Šã«å¼¾ããŸã„å ´åˆ
              cat.vy = Math.max(cat.vy, 0);
            } else {
              // çŒ«ãŒéšœå®³ç‰©ã‚ˆã‚Šä¸Š => ä¸Šã‹ã‚‰ä¸‹ã«æŠ¼ã—å‡ºã—
              cat.y = o.y - cat.height;
              // ä¸‹ã«å¼¾ããŸã„å ´åˆ
              cat.vy = Math.min(cat.vy, 0) + 5;
            }
          }
        }
      }
    }

    // ==========================================
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›
    // ==========================================
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        keys.jump = true;
      }
      if (e.key === "l" || e.key === "L") {
        keys.right = true;
      }
      if (e.key === "k" || e.key === "K") {
        keys.left = true;
      }
    });
    document.addEventListener("keyup", (e) => {
      if (e.code === "Space") {
        keys.jump = false;
      }
      if (e.key === "l" || e.key === "L") {
        keys.right = false;
      }
      if (e.key === "k" || e.key === "K") {
        keys.left = false;
      }
    });

    // ==========================================
    // ã‚¹ãƒãƒ›(ãƒœã‚¿ãƒ³)å…¥åŠ›
    // ==========================================
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const jumpBtn = document.getElementById("jumpBtn");

    function pressLeft(val)  { keys.left  = val; }
    function pressRight(val) { keys.right = val; }
    function pressJump(val)  { keys.jump  = val; }

    // ã‚¿ãƒƒãƒ / ãƒã‚¦ã‚¹
    leftBtn.addEventListener("touchstart",  () => pressLeft(true));
    leftBtn.addEventListener("touchend",    () => pressLeft(false));
    leftBtn.addEventListener("mousedown",   () => pressLeft(true));
    leftBtn.addEventListener("mouseup",     () => pressLeft(false));

    rightBtn.addEventListener("touchstart", () => pressRight(true));
    rightBtn.addEventListener("touchend",   () => pressRight(false));
    rightBtn.addEventListener("mousedown",  () => pressRight(true));
    rightBtn.addEventListener("mouseup",    () => pressRight(false));

    jumpBtn.addEventListener("touchstart",  () => pressJump(true));
    jumpBtn.addEventListener("touchend",    () => pressJump(false));
    jumpBtn.addEventListener("mousedown",   () => pressJump(true));
    jumpBtn.addEventListener("mouseup",     () => pressJump(false));

    // ==========================================
    // update
    // ==========================================
    function update() {
      if (!isGameRunning) return;

      // æ¨ªç§»å‹•
      cat.vx = 0;
      if (keys.left)  { cat.vx = -MOVE_SPEED; cat.facingRight = false; }
      if (keys.right) { cat.vx =  MOVE_SPEED; cat.facingRight = true; }

      // ã‚¸ãƒ£ãƒ³ãƒ—
      if (keys.jump && cat.onGround) {
        cat.vy = JUMP_POWER;
        cat.onGround = false;
        // ãƒ©ãƒ³ãƒ€ãƒ ã§meowå†ç”Ÿ(ä¾‹: 20%ã®ç¢ºç‡)
        if (Math.random() < 0.2) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¾Œã§ã‚ã‚Œã°å†ç”Ÿå¯èƒ½
          meowSound.currentTime = 0;
          meowSound.play().catch(e => console.log(e));
        }
      }

      // é‡åŠ›
      cat.vy += GRAVITY;

      // åº§æ¨™æ›´æ–°
      cat.x += cat.vx;
      cat.y += cat.vy;

      // ç”»é¢å·¦å³ç«¯ã®ã¯ã¿å‡ºã—é˜²æ­¢
      if (cat.x < 0) {
        cat.x = 0;
      } else if (cat.x + cat.width > CANVAS_WIDTH) {
        cat.x = CANVAS_WIDTH - cat.width;
      }

      // è¶³å ´ã¨ã®è¡çª
      cat.onGround = false;
      for (let p of platforms) {
        if (
          cat.x < p.x + p.width &&
          cat.x + cat.width > p.x &&
          cat.y + cat.height > p.y &&
          cat.y + cat.height - cat.vy <= p.y
        ) {
          cat.y = p.y - cat.height;
          cat.vy = 0;
          cat.onGround = true;
        }
      }

      // è½ä¸‹(ç”»é¢ä¸‹ã«æ¶ˆãˆãŸ)ãƒã‚§ãƒƒã‚¯
      if (cat.y > CANVAS_HEIGHT) {
        lives--;
        if (lives <= 0) {
          alert("Game Over...ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã­");
          isGameRunning = false;
        } else {
          // å†é…ç½®
          cat.x = 160;
          cat.y = 200;
          cat.vy = 0;
          cat.onGround = false;
        }
      }

      // ä¸Šã«è¡Œã£ãŸã‚‰ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä¸‹ã’ã‚‹
      if (cat.y < 200) {
        const diff = 200 - cat.y;
        cat.y = 200;
        for (let p of platforms) {
          p.y += diff;
        }
        for (let o of obstacles) {
          o.y += diff;
        }
        distance += diff;
        addNewPlatformsIfNeeded();
      }

      // éšœå®³ç‰©æ›´æ–°
      updateObstacles();

      // ã‚´ãƒ¼ãƒ«åˆ¤å®š
      if (distance >= GOAL_DIST) {
        alert("ã‚´ãƒ¼ãƒ«ï¼ãŠã‚ã§ã¨ã†ï¼ï¼");
        isGameRunning = false;
      }
    }

    // ==========================================
    // draw
    // ==========================================
    function draw() {
      drawBackground();
      drawPlatforms();
      drawObstacles();
      drawCat();
      drawHUD();
    }

    function drawBackground() {
      let area = getCurrentArea(distance);
      if (area === "ground") {
        ctx.fillStyle = "#fff"; // åœ°ä¸Š(æ·¡ã„é»„è‰²)
      } else if (area === "sky") {
        ctx.fillStyle = "#cceeff"; // ç©º(æ°´è‰²)
      } else if (area === "space") {
        ctx.fillStyle = "#303060"; // å®‡å®™(ç´ºè‰²)
      } else if (area === "rainbow") {
        // ç°¡æ˜“è™¹è‰²ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        let grad = ctx.createLinearGradient(0,0,CANVAS_WIDTH,0);
        grad.addColorStop(0,   "#ff8a8a"); 
        grad.addColorStop(0.2, "#ffe48a");
        grad.addColorStop(0.4, "#d1ff8a");
        grad.addColorStop(0.6, "#8afff6");
        grad.addColorStop(0.8, "#8ad1ff");
        grad.addColorStop(1,   "#d48aff");
        ctx.fillStyle = grad;
      } else {
        // ã‚´ãƒ¼ãƒ«å¾Œ(ä¸€å¿œç™½ã£ã½ã„)
        ctx.fillStyle = "#eaeaea";
      }
      ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    }

    function drawPlatforms() {
      for (let p of platforms) {
        // è¶³å ´
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.width, p.height);
        // æ”¯æŸ±
        let cx = p.x + p.width/2 - TOWER_COLUMN_WIDTH/2;
        let cy = p.y;
        ctx.fillRect(cx, cy, TOWER_COLUMN_WIDTH, TOWER_COLUMN_HEIGHT);
      }
    }

    function drawObstacles() {
      ctx.font = "28px serif";
      ctx.textBaseline = "top";
      for (let o of obstacles) {
        ctx.fillText(o.symbol, o.x, o.y);
      }
    }

    function drawCat() {
      // çµµæ–‡å­—ã§çŒ«ã‚’æç”»
      const catEmoji = "ğŸˆ";
      ctx.save();
      ctx.font = "38px serif"; 
      ctx.textBaseline = "top";

      // çŒ«ãŒè¶³å ´ã«æ¥åœ°ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã‚ˆã†ã€
      // å¤šå°‘yã‚’èª¿æ•´(ç’°å¢ƒã«ã‚ˆã£ã¦ã¯+/-æ•°pxã‚’å¤‰æ›´)
      let drawX = cat.x;
      let drawY = cat.y - 6;  // â†ä¸Šã«å°‘ã—å¼•ãä¸Šã’ã¦ã€Œæµ®ã‹ãªã„ã€ã‚ˆã†ã«

      if (!cat.facingRight) {
        // å·¦å‘ã
        ctx.translate(drawX, drawY);
        ctx.fillText(catEmoji, 0, 0);
      } else {
        // å³å‘ã(åè»¢)
        ctx.translate(drawX + cat.width, drawY);
        ctx.scale(-1, 1);
        ctx.fillText(catEmoji, 0, 0);
      }
      ctx.restore();
    }

    function drawHUD() {
      // è·é›¢
      ctx.fillStyle = "#000";
      ctx.font = "16px sans-serif";
      ctx.fillText(`Height: ${Math.floor(distance)}`, 10, 10);

      // ãƒ©ã‚¤ãƒ•(ğŸŸ)
      let fishX = 10;
      let fishY = 30;
      for (let i = 0; i < lives; i++) {
        ctx.fillText("ğŸŸ", fishX + i*25, fishY);
      }
    }

    // ==========================================
    // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
    // ==========================================
    function gameLoop() {
      frameCount++;
      update();
      ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
      draw();
      if (isGameRunning) {
        requestAnimationFrame(gameLoop);
      }
    }

    // åˆæœŸåŒ–
    initPlatforms();
    gameLoop();
  </script>
</body>
</html>
